#! /usr/bin/env pdo-shell

## Copyright 2023 Intel Corporation
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.

## Two shell variables are used:
##    data -- the directory where the contract objects are stored
##    path -- the directory where the PSH scripts are stored
##
## $ pdo-shell -s create.psh -m path <contract path>

set --conditional -s home -v .
set --conditional -s data -v .
set --conditional -s save -v .
set --conditional -s _bin_ -v ${home}/contracts/identity/scripts

script -f ${_bin_}/init.psh

set -s _contract_ -v ${save}/identity.pdo
set -s _owner_ -v user1

trap_error

## =================================================================
echo ${HEADER} create the identity contract ${ENDC}
## =================================================================
identity -n ${_owner_}

contract create -c identity_identity --source ${contracts}/_identity_identity -f ${_contract_}
if -o ${_error_code_} 0
   echo ${ERROR} [Error ${_error_code_}] failed to create the identity contract ${ENDC}
   exit -v ${_error_code_}
fi

identity_wallet_contract initialize -w -f ${_contract_} \
    --description "this is a test identity"
if -o ${_error_code_} 0
   echo ${ERROR} [Error ${_error_code_}] failed to initialize the identity contract ${ENDC}
   exit -v ${_error_code_}
fi

## =================================================================
echo ${HEADER} test normal keys ${ENDC}
## =================================================================
script -f ${_path_}/normal_keys.psh
if -o ${_error_code_} 0
   echo ${ERROR} [ERROR ${_error_code_}] normal key test failed; ${_error_message_}
   exit -v ${_error_code_}
fi

## =================================================================
echo ${HEADER} test hardened keys ${ENDC}
## =================================================================
script -f ${_path_}/hardened_keys.psh
if -o ${_error_code_} 0
   echo ${ERROR} [ERROR ${_error_code_}] hardened key test failed; ${_error_message_}
   exit -v ${_error_code_}
fi


exit
